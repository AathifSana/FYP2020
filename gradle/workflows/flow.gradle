def commonProperties = ['retries': 3, 'retry.backoff': 1000]

ext.sparkProperties = { driverCores, driverMemory, executorCores, executorMemory ->
    "driverCores='$driverCores' " +
    "driverMemory='$driverMemory' " +
    "executorCores='$executorCores' " +
    "executorMemory='$executorMemory' "
}

hadoop {
    namespace('Spark') {

        workflow('FrequentlyBought'){
            def preProcessedDir = "\${RESOURCES_LOCATION}preprocessed"
            def segmentsDir = "\${RESOURCES_LOCATION}segments"
            def recsDir = "\${RESOURCES_LOCATION}recs"

            commandJob('PreProcessing') {
                set properties: commonProperties
                uses "spark-submit " +
                        "--master local " +
                        "${sparkProperties(1,'1g',1,'1g')}" +
                        "--class jobs.DataPreprocessingJob " +
                        "\${JAR_LOCATION} " +
                        "--input \${RESOURCES_LOCATION}inital/Online_Retail.csv " +
                        "--output $preProcessedDir"

            }

            commandJob('CustomerSegmentation') {
                set properties: commonProperties
                depends  'PreProcessing'
                uses "spark-submit " +
                        "--master local " +
                        "${sparkProperties(1,'1g',1,'1g')}" +
                        "--class jobs.CustomerSegmentationJob " +
                        "\${JAR_LOCATION} " +
                        "--input $preProcessedDir " +
                        "--output $segmentsDir"

            }

            commandJob('FrequentlyBoughtGeneral') {
                set properties: commonProperties
                depends  'CustomerSegmentation'
                uses "spark-submit " +
                        "--master local " +
                        "${sparkProperties(1,'1g',1,'1g')}" +
                        "--class jobs.FrequentlyBoughtJob " +
                        "\${JAR_LOCATION} " +
                        "--input $preProcessedDir " +
                        "--output $recsDir/gen " +
                        "--support 0.01 " +
                        "--confidence 0.2 " +
                        "--inputSeg $segmentsDir/customer_segments"

            }

            commandJob('FrequentlyBoughtSegmented') {
                set properties: commonProperties
                depends  'FrequentlyBoughtGeneral'
                uses "spark-submit " +
                        "--master local " +
                        "${sparkProperties(1,'1g',1,'1g')}" +
                        "--class jobs.FrequentlyBoughtJob " +
                        "\${JAR_LOCATION} " +
                        "--input $preProcessedDir " +
                        "--output $recsDir/gen " +
                        "--support 0.01 " +
                        "--confidence 0.2 " +
                        "--inputSeg $segmentsDir/customer_segments " +
                        "--segment 3 " +
                        "--recFill $recsDir/gen"

            }

            targets 'FrequentlyBoughtSegmented'
        }

    }
}